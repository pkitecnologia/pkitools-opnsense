#!/bin/sh
INTERFACE_NAME=$1

[ -n "$INTERFACE_NAME" ] || {
    echo "usage: $0 INTERFACE_NAME" >&2
    exit 1
}

# Binaries
XMLLINT="/usr/local/bin/xmllint"
IFCONFIG="/sbin/ifconfig"
AWK="/usr/bin/awk"
SUDO="/usr/local/bin/sudo"

# Get physical interface name from config
PHYSICAL_INTERFACE=$($SUDO $XMLLINT --xpath "/opnsense/interfaces/$INTERFACE_NAME/if/text()" /conf/config.xml 2>/dev/null)

if [ -z "$PHYSICAL_INTERFACE" ]; then
    echo "Unable to resolve physical interface for $INTERFACE_NAME" >&2
    exit 1
fi

# Get first IP address from ifconfig output
SOURCE_IP=$($IFCONFIG "$PHYSICAL_INTERFACE" 2>/dev/null | $AWK '/inet / { print $2; exit }')

if [ -z "$SOURCE_IP" ]; then
    echo "Unable to get IP address from interface $PHYSICAL_INTERFACE" >&2
    exit 1
fi

/usr/local/bin/speedtest-cli --secure --timeout 30 --json --source ${SOURCE_IP}
